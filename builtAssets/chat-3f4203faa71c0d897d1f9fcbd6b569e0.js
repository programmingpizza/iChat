"use strict";if("undefined"!=typeof window&&"undefined"==typeof exports&&"object"!=typeof window.utils&&(window.utils={}),"undefined"!=typeof exports)var _=require("underscore");!function(e){function t(e){return e.replace(/&/g,"&amp;").replace(h,function(e){var t=e.charCodeAt(0),i=e.charCodeAt(1);return"&#"+(1024*(t-55296)+(i-56320)+65536)+";"}).replace(d,function(e){return"&#"+e.charCodeAt(0)+";"}).replace(/</g,"&lt;").replace(/>/g,"&gt;")}function i(){var e=window.location.pathname.split("/");e=_.filter(e,function(e){return e.length});var t=window.location.origin;return e.length&&(t=t+"/"+e.join("/")),t+"/"}function o(e){return e.trim()}function s(e){var t=/\B@([\w\.]+)(?!@)\b/g;return e.replace(t,'<span class="lcb-message-mention">@$1</span>')}function n(e,t){if(!t.rooms)return e;var i=/\B(\#[a-z0-9_]+)\b/g;return e.replace(i,function(e){var i=e.substring(1),o=t.rooms.find(function(e){return e.attributes.slug===i});return o?'<a href="#!/room/'+o.id+'">&#35;'+i+"</a>":e})}function r(e){var t=/^\s*(upload:\/\/[-A-Z0-9+&*@#\/%?=~_|!:,.;'"!()]*)\s*$/i;return e.replace(t,function(e){return i()+e.substring(9)})}function a(e){return u.test(e)?e.replace(u,function(e){var i=t(_.unescape(e));return'<a class="thumbnail" href="'+i+'" target="_blank" rel="noreferrer nofollow"><img src="'+i+'" alt="Pasted Image" /></a>'}):e.replace(m,function(e){var i=t(_.unescape(e));return'<a href="'+i+'" target="_blank" rel="noreferrer nofollow">'+e+"</a>"})}function l(e,t){var i=new RegExp("\\B(:[a-z0-9_\\+\\-]+:)[\\b]?","ig");return e.replace(i,function(e){var i=e.split(":")[1],o=_.find(t.emotes,function(e){return e.emote===i});if(!o)return e;var s=_.escape(o.image),n=_.escape(":"+o.emote+":"),r=_.escape(o.size||20);return'<img class="emote" src="'+s+'" title="'+n+'" alt="'+n+'" width="'+r+'" height="'+r+'" />'})}function c(e,t){return _.each(t.replacements,function(t){e=e.replace(new RegExp(t.regex,"ig"),t.template)}),e}var h=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,d=/([^\#-~| |!])/g,u=/^\s*((https?|ftp):\/\/[-A-Z0-9\u00a1-\uffff+&@#\/%?=~_|!:,.;'"!()]*[-A-Z0-9\u00a1-\uffff+&@#\/%=~_|][.](jpe?g|png|gif))\s*(\?[\w-]+(=[\w-]*)?(&[\w-]+(=[\w-]*)?)*)?$/i,m=/((https?|ftp):\/\/[-A-Z0-9\u00a1-\uffff+&*@#\/%?=~_|!:,.;'"!()]*[-A-Z0-9\u00a1-\uffff+&@#\/%=~_|])/gi;e.format=function(e,t){var i=[o,s,n,r,a,l,c];return _.each(i,function(i){e=i(e,t)}),e}}("undefined"==typeof exports?window.utils.message={}:exports);var UserModel=Backbone.Model.extend(),UsersCollection=Backbone.Collection.extend({model:UserModel}),MessageModel=Backbone.Model.extend(),MessagesCollection=Backbone.Collection.extend({model:MessageModel}),FileModel=Backbone.Model.extend(),FilesCollection=Backbone.Collection.extend({model:FileModel}),RoomModel=Backbone.Model.extend({initialize:function(){this.messages=new MessagesCollection,this.users=new UsersCollection,this.files=new FilesCollection,this.lastMessage=new Backbone.Model,this.users.on("add",_.bind(function(e){this.trigger("users:add",e,this)},this)),this.users.on("remove",function(e){this.trigger("users:remove",e,this)},this)},loaded:!1}),RoomsCollection=Backbone.Collection.extend({model:RoomModel,initialize:function(){this.current=new Backbone.Model,this.last=new Backbone.Model}});+function(e,t,i){e.LCB=e.LCB||{},e.LCB.BrowserView=Backbone.View.extend({events:{"submit .lcb-rooms-add":"create","keyup .lcb-rooms-browser-filter-input":"filter","change .lcb-rooms-switch":"toggle","click .lcb-rooms-switch-label":"toggle"},initialize:function(e){this.client=e.client,this.template=Handlebars.compile(t("#template-room-browser-item").html()),this.userTemplate=Handlebars.compile(t("#template-room-browser-item-user").html()),this.rooms=e.rooms,this.rooms.on("add",this.add,this),this.rooms.on("remove",this.remove,this),this.rooms.on("change:description change:name",this.update,this),this.rooms.on("change:lastActive",i.debounce(this.updateLastActive,200),this),this.rooms.on("change:joined",this.updateToggles,this),this.rooms.on("users:add",this.addUser,this),this.rooms.on("users:remove",this.removeUser,this),this.rooms.on("users:add users:remove add remove",this.sort,this),this.rooms.current.on("change:id",function(e,t){"list"===t&&this.sort()},this)},updateToggles:function(e,t){this.$(".lcb-rooms-switch[data-id="+e.id+"]").prop("checked",t)},toggle:function(e){e.preventDefault();var i=t(e.currentTarget),o=i.is(":checkbox")&&i||i.siblings('[type="checkbox"]'),s=o.data("id"),n=this.rooms.get(s);n&&(n.get("joined")?this.client.leaveRoom(n.id):this.client.joinRoom(n))},add:function(e){var e=e.toJSON?e.toJSON():e,t=i.extend(e,{lastActive:moment(e.lastActive).calendar()});this.$(".lcb-rooms-list").append(this.template(t))},remove:function(e){this.$(".lcb-rooms-list-item[data-id="+e.id+"]").remove()},update:function(e){this.$(".lcb-rooms-list-item[data-id="+e.id+"] .lcb-rooms-list-item-name").text(e.get("name")),this.$(".lcb-rooms-list-item[data-id="+e.id+"] .lcb-rooms-list-item-description").text(e.get("description")),this.$(".lcb-rooms-list-item[data-id="+e.id+"] .lcb-rooms-list-item-participants").text(e.get("participants"))},updateLastActive:function(e){this.$(".lcb-rooms-list-item[data-id="+e.id+"] .lcb-rooms-list-item-last-active .value").text(moment(e.get("lastActive")).calendar())},sort:function(e){var i=this,o=this.$(".lcb-rooms-list-item");this.$el.hasClass("hide")&&e&&e.id===this.client.user.id||(o.sort(function(e,o){var s=i.rooms.get(t(e).data("id")),n=i.rooms.get(t(o).data("id")),r=s.users.length,a=n.users.length,l=s.get("joined"),c=n.get("joined");if(l&&c||!l&&!c){if(r>a)return-1;if(a>r)return 1}return l?-1:c?1:0}),o.detach().appendTo(this.$(".lcb-rooms-list")))},filter:function(e){e.preventDefault();var i=t(e.currentTarget),o=i.val().toLowerCase();this.$(".lcb-rooms-list-item").each(function(){var e=t(this).find(".lcb-rooms-list-item-name").text().toLowerCase();t(this).toggle(e.indexOf(o)>=0)})},create:function(e){var t=this;e.preventDefault();var i=this.$(e.target),o=this.$("#lcb-add-room"),s=this.$(".lcb-room-name"),n=this.$(".lcb-room-slug"),r=this.$(".lcb-room-description"),a=this.$(".lcb-room-password"),l=this.$(".lcb-room-confirm-password"),c=this.$(".lcb-room-private"),h={name:s.val().trim(),slug:n.val().trim(),description:r.val(),password:a.val(),"private":!!c.prop("checked"),callback:function(){o.modal("hide"),i.trigger("reset")}};return s.parent().removeClass("has-error"),n.parent().removeClass("has-error"),l.parent().removeClass("has-error"),h.name?h.slug?h.password?h.password!==l.val()?void l.parent().addClass("has-error"):void swal({title:"Password-protected room",text:"You're creating a room with a shared password.\nAnyone who obtains the password may enter the room.",showCancelButton:!0},function(){t.client.events.trigger("rooms:create",h)}):void this.client.events.trigger("rooms:create",h):void n.parent().addClass("has-error"):void s.parent().addClass("has-error")},addUser:function(e,t){this.$('.lcb-rooms-list-item[data-id="'+t.id+'"]').find(".lcb-rooms-list-users").prepend(this.userTemplate(e.toJSON()))},removeUser:function(e,t){this.$('.lcb-rooms-list-item[data-id="'+t.id+'"]').find('.lcb-rooms-list-user[data-id="'+e.id+'"]').remove()}})}(window,$,_),+function(e,t,i){e.LCB=e.LCB||{},e.LCB.RoomView=Backbone.View.extend({events:{"scroll .lcb-messages":"updateScrollLock","keypress .lcb-entry-input":"sendMessage","click .lcb-entry-button":"sendMessage","click .lcb-room-toggle-sidebar":"toggleSidebar","click .show-edit-room":"showEditRoom","click .hide-edit-room":"hideEditRoom","click .submit-edit-room":"submitEditRoom","click .archive-room":"archiveRoom","click .lcb-room-poke":"poke","click .lcb-upload-trigger":"upload"},initialize:function(i){this.client=i.client;var o=this.model.get("owner")===this.client.user.id,s=o||!this.model.get("hasPassword");this.model.set("iAmOwner",o),this.model.set("iCanEdit",s),this.template=i.template,this.messageTemplate=Handlebars.compile(t("#template-message").html()),this.render(),this.model.on("messages:new",this.addMessage,this),this.model.on("change",this.updateMeta,this),this.model.on("remove",this.goodbye,this),this.model.users.on("change",this.updateUser,this),this.usersList=new e.LCB.RoomUsersView({el:this.$(".lcb-room-sidebar-users"),collection:this.model.users}),this.filesList=new e.LCB.RoomFilesView({el:this.$(".lcb-room-sidebar-files"),collection:this.model.files})},render:function(){this.$el=t(this.template(i.extend(this.model.toJSON(),{sidebar:store.get("sidebar")}))),this.$messages=this.$(".lcb-messages"),this.scrollLocked=!0,this.$messages.on("scroll",i.bind(this.updateScrollLock,this)),this.atwhoMentions(),this.atwhoAllMentions(),this.atwhoRooms(),this.atwhoEmotes(),this.selectizeParticipants()},atwhoTplEval:function(e,t){var i;try{return e.replace(/\$\{([^\}]*)\}/g,function(e,i,o){return(t[i]||"").replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&lt;").replace(/>/g,"&gt;")})}catch(o){return i=o,""}},getAtwhoUserFilter:function(e){var t=this.client.user;return function(i,o,s){var n=i.toLowerCase(),r=e.filter(function(e){var i=e.attributes;if(e.id===t.id)return!1;i.safeName||(i.safeName=i.displayName.replace(/\W/g,""));var o=i.username.toLowerCase(),s=o.indexOf(n);if(s>-1)return i.atwho_order=s,!0;var r=i.safeName.toLowerCase(),a=r.indexOf(n);return a>-1?(i.atwho_order=a+i.username.length,!0):!1});return r.map(function(e){return e.attributes})}},atwhoMentions:function(){function e(e,t,i){return t.sort(function(e,t){return e.atwho_order-t.atwho_order})}var t={at:"@",tpl:'<li data-value="@${username}"><img src="https://www.gravatar.com/avatar/${avatar}?s=20" height="20" width="20" /> @${username} <small>${displayName}</small></li>',callbacks:{filter:this.getAtwhoUserFilter(this.model.users),sorter:e,tpl_eval:this.atwhoTplEval}};this.$(".lcb-entry-input").atwho(t)},atwhoAllMentions:function(){function e(e,t,i){var s=o.client.getUsersSync(),n=o.getAtwhoUserFilter(s);return n(e,t,i)}function t(e,t,i){return t.sort(function(e,t){return e.atwho_order-t.atwho_order})}var o=this,s={at:"@@",tpl:'<li data-value="@${username}"><img src="https://www.gravatar.com/avatar/${avatar}?s=20" height="20" width="20" /> @${username} <small>${displayName}</small></li>',callbacks:{filter:e,sorter:t,tpl_eval:o.atwhoTplEval}};this.$(".lcb-entry-input").atwho(s);var n=i.extend(s,{at:"@"});this.$(".lcb-entry-participants").atwho(n),this.$(".lcb-room-participants").atwho(n)},selectizeParticipants:function(){var e=this;this.$(".lcb-entry-participants").selectize({delimiter:",",create:!1,load:function(t,o){if(!t.length)return o();var s=e.client.getUsersSync(),n=s.map(function(e){return e.attributes.username});n=i.filter(n,function(e){return-1!==e.indexOf(t)}),s=i.map(n,function(e){return{value:e,text:e}}),o(s)}})},atwhoRooms:function(){function e(e,i,o){var s=e.toLowerCase(),n=t.filter(function(e){var t=e.attributes.slug.toLowerCase();return t.indexOf(s)>-1});return n.map(function(e){return e.attributes})}var t=this.client.rooms;this.$(".lcb-entry-input").atwho({at:"#",search_key:"slug",callbacks:{filter:e,tpl_eval:this.atwhoTplEval},tpl:'<li data-value="#${slug}">#${slug} <small>${name}</small></li>'})},atwhoEmotes:function(){var e=this;this.client.getEmotes(function(t){e.$(".lcb-entry-input").atwho({at:":",search_key:"emote",data:t,tpl:'<li data-value=":${emote}:"><img src="${image}" height="32" width="32" alt=":${emote}:" /> :${emote}:</li>'})})},goodbye:function(){swal("Archived!",'"'+this.model.get("name")+'" has been archived.',"warning")},updateMeta:function(){var e=this;this.$(".lcb-room-heading .name").text(this.model.get("name")),this.$(".lcb-room-heading .slug").text("#"+this.model.get("slug")),this.$(".lcb-room-participants").text(this.model.get("participants")),this.formatMessage(i.escape(this.model.get("description")),function(t){e.$(".lcb-room-description").html(t)})},showEditRoom:function(e){e&&e.preventDefault();var t=this.$(".lcb-room-edit"),i=t.find('input[name="name"]'),o=t.find('textarea[name="description"]'),s=t.find('input[name="password"]'),n=t.find('input[name="confirmPassword"]');i.val(this.model.get("name")),o.val(this.model.get("description")),s.val(""),n.val(""),t.modal()},hideEditRoom:function(e){e&&e.preventDefault(),this.$(".lcb-room-edit").modal("hide")},submitEditRoom:function(e){e&&e.preventDefault();var t=this.$(".lcb-room-edit"),i=t.find('input[name="name"]'),o=t.find('textarea[name="description"]'),s=t.find('input[name="password"]'),n=t.find('input[name="confirmPassword"]'),r=this.$('.edit-room textarea[name="participants"]');return i.parent().removeClass("has-error"),n.parent().removeClass("has-error"),i.val()?s.val()&&s.val()!==n.val()?void n.parent().addClass("has-error"):(this.client.events.trigger("rooms:update",{id:this.model.id,name:i.val(),description:o.val(),password:s.val(),participants:r.val()}),void t.modal("hide")):void i.parent().addClass("has-error")},archiveRoom:function(e){var t=this;swal({title:'Do you really want to archive "'+this.model.get("name")+'"?',text:"You will not be able to open it!",type:"error",confirmButtonText:"Yes, I'm sure",allowOutsideClick:!0,confirmButtonColor:"#DD6B55",showCancelButton:!0,closeOnConfirm:!0},function(e){e&&(t.$(".lcb-room-edit").modal("hide"),t.client.events.trigger("rooms:archive",{room:t.model.id}))})},sendMessage:function(e){if(!("keypress"===e.type&&13!==e.keyCode||e.altKey)&&("keypress"!==e.type||13!==e.keyCode||!e.shiftKey)&&(e.preventDefault(),this.client.status.get("connected"))){var t=this.$(".lcb-entry-input");t.val()&&(this.client.events.trigger("messages:send",{room:this.model.id,text:t.val()}),t.val(""),this.scrollLocked=!0,this.scrollMessages())}},addMessage:function(e){e.paste=/\n/i.test(e.text);var i=moment(e.posted);e.fragment=this.lastMessageOwner===e.owner.id&&i.diff(this.lastMessagePosted,"minutes")<2,e.own=this.client.user.id===e.owner.id,e.mentioned=new RegExp("\\B@("+this.client.user.get("username")+"|all)(?!@)\\b","i").test(e.text);var o=t(this.messageTemplate(e).trim()),s=o.find(".lcb-message-text"),n=this;this.formatMessage(s.html(),function(t){s.html(t),o.find("time").updateTimeStamp(),n.$messages.append(o),e.fragment||(n.lastMessagePosted=i,n.lastMessageOwner=e.owner.id),n.scrollMessages()})},formatMessage:function(t,i){var o=this.client;o.getEmotes(function(s){o.getReplacements(function(n){var r={emotes:s,replacements:n,rooms:o.rooms},a=e.utils.message.format(t,r);i(a)})})},updateScrollLock:function(){return this.scrollLocked=this.$messages[0].scrollHeight-this.$messages.scrollTop()-5<=this.$messages.outerHeight(),this.scrollLocked},scrollMessages:function(e){!e&&!this.scrollLocked||this.$el.hasClass("hide")||(this.$messages[0].scrollTop=this.$messages[0].scrollHeight)},toggleSidebar:function(i){i&&i.preventDefault&&i.preventDefault(),this.$el.siblings(".lcb-room").andSelf().toggleClass("lcb-room-sidebar-opened"),t(e).width()>767&&(this.scrollMessages(),store.set("sidebar",this.$el.hasClass("lcb-room-sidebar-opened")))},destroy:function(){this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},poke:function(e){var i=t(e.currentTarget),o=i.closest("[data-id],[data-owner]"),s=o.data("owner")||o.data("id"),n=this.model.users.findWhere({id:s});if(n){var r=this.$(".lcb-entry-input"),a=t.trim(r.val()),l=(a.length>0?" ":"")+"@"+n.get("username")+" ";r.val(a+l).focus()}},upload:function(e){e.preventDefault(),this.model.trigger("upload:show",this.model)},updateUser:function(e){var t=this.$('.lcb-message[data-owner="'+e.id+'"]');t.find(".lcb-message-username").text("@"+e.get("username")),t.find(".lcb-message-displayname").text(e.get("displayName"))}}),e.LCB.RoomSidebarListView=Backbone.View.extend({initialize:function(e){this.template=Handlebars.compile(t(this.templateSelector).html()),this.collection.on("add remove",function(){this.count()},this),this.collection.on("add",function(e){this.add(e.toJSON())},this),this.collection.on("change",function(e){this.update(e.toJSON())},this),this.collection.on("remove",function(e){this.remove(e.id)},this),this.render()},render:function(){this.collection.each(function(e){this.add(e.toJSON())},this),this.count()},add:function(e){this.$(".lcb-room-sidebar-list").prepend(this.template(e))},remove:function(e){this.$(".lcb-room-sidebar-item[data-id="+e+"]").remove()},count:function(e){this.$(".lcb-room-sidebar-items-count").text(this.collection.length)},update:function(e){this.$(".lcb-room-sidebar-item[data-id="+e.id+"]").replaceWith(this.template(e))}}),e.LCB.RoomUsersView=e.LCB.RoomSidebarListView.extend({templateSelector:"#template-user"}),e.LCB.RoomFilesView=e.LCB.RoomSidebarListView.extend({templateSelector:"#template-file"})}(window,$,_),+function(e,t,i){e.LCB=e.LCB||{},e.LCB.StatusView=Backbone.View.extend({initialize:function(e){var t=this;this.client=e.client,this.client.status.on("change:connected",function(e,i){t.$el.find('[data-status="connected"]').toggle(i),t.$el.find('[data-status="disconnected"]').toggle(!i)})}})}(window,$,_),+function(e,t,i,o){e.LCB=e.LCB||{},e.LCB.WindowView=Backbone.View.extend({el:"html",focus:!0,count:0,mentions:0,countFavicon:new Favico({position:"down",animation:"none",bgColor:"#b94a48"}),mentionsFavicon:new Favico({position:"left",animation:"none",bgColor:"#f22472"}),initialize:function(o){var s=this;this.client=o.client,this.rooms=o.rooms,this.originalTitle=document.title,this.title=this.originalTitle,t(e).on("focus blur",i.bind(this.onFocusBlur,this)),this.rooms.current.on("change:id",function(e,t){var i=this.rooms.get(t),o=i?i.get("name"):"Rooms";this.updateTitle(o)},this),this.rooms.on("change:name",function(e){e.id===this.rooms.current.get("id")&&this.updateTitle(e.get("name"))},this),this.rooms.on("messages:new",this.onNewMessage,this),i.defer(function(){s.updateTitle()})},onFocusBlur:function(e){this.focus="focus"===e.type,this.focus&&(clearInterval(this.titleTimer),clearInterval(this.faviconBadgeTimer),this.count=0,this.mentions=0,this.titleTimer=!1,this.titleTimerFlip=!1,this.faviconBadgeTimer=!1,this.faviconBadgeTimerFlip=!1,this.updateTitle(),this.mentionsFavicon.reset())},onNewMessage:function(e){this.focus||e.historical||e.owner.id===this.client.user.id||(this.countMessage(e),this.flashTitle(),this.flashFaviconBadge())},countMessage:function(e){++this.count,e.mentioned&&++this.mentions},flashTitle:function(){var e="";this.count>0&&(e+="("+parseInt(this.count),this.mentions>0&&(e+="/"+parseInt(this.mentions)+"@"),e+=") "),document.title=e+this.title},flashFaviconBadge:function(){if(!this.faviconBadgeTimer){this._flashFaviconBadge();var e=i.bind(this._flashFaviconBadge,this);this.faviconBadgeTimer=setInterval(e,2e3)}},_flashFaviconBadge:function(){this.mentions>0&&this.faviconBadgeTimerFlip?this.mentionsFavicon.badge(this.mentions):this.countFavicon.badge(this.count),this.faviconBadgeTimerFlip=!this.faviconBadgeTimerFlip},updateTitle:function(e){if(!e){var t=this.rooms.get(this.rooms.current.get("id"));e=t&&t.get("name")||"Rooms"}e?this.title=e+" Â· "+this.originalTitle:this.title=this.originalTitle,document.title=this.title}}),e.LCB.HotKeysView=Backbone.View.extend({el:"html",keys:{"up+shift+alt down+shift+alt":"nextRoom","s+shift+alt":"toggleRoomSidebar","g+shift+alt":"openGiphyModal","space+shift+alt":"recallRoom"},initialize:function(e){this.client=e.client,this.rooms=e.rooms},nextRoom:function(e){var t=40===e.keyCode?"next":"prev",i=40===e.keyCode?"first":"last",o=this.$(".lcb-tabs").find("[data-id].selected")[t]();0===o.length&&(o=this.$(".lcb-tabs").find("[data-id]:"+i)),this.client.events.trigger("rooms:switch",o.data("id"))},recallRoom:function(){this.client.events.trigger("rooms:switch",this.rooms.last.get("id"))},toggleRoomSidebar:function(e){e.preventDefault();var t=this.client.view.panes.views[this.rooms.current.get("id")];t&&t.toggleSidebar&&t.toggleSidebar()},openGiphyModal:function(e){this.client.options.giphyEnabled&&(e.preventDefault(),t(".lcb-giphy").modal("show"))}}),e.LCB.DesktopNotificationsView=Backbone.View.extend({focus:!0,openNotifications:[],openMentions:[],initialize:function(s){o.config({pageVisibility:!1}),this.client=s.client,this.rooms=s.rooms,t(e).on("focus blur unload",i.bind(this.onFocusBlur,this)),this.rooms.on("messages:new",this.onNewMessage,this)},onFocusBlur:function(e){this.focus="focus"===e.type,i.each(i.merge(this.openNotifications,this.openMentions),function(e){e.close&&e.close()})},onNewMessage:function(e){this.focus||e.historical||e.owner.id===this.client.user.id||this.createDesktopNotification(e)},createDesktopNotification:function(t){var i=this;if(o.isSupported&&o.permissionLevel()==o.PERMISSION_GRANTED){var s=t.room.id,n=t.owner.avatar,r="https://www.gravatar.com/avatar/"+n+"?s=50",a=t.owner.displayName+" in "+t.room.name,l=t.mentioned,c=o.createNotification(a,{body:t.text,icon:r,tag:t.id,onclick:function(){e.focus(),i.client.events.trigger("rooms:switch",s)}});if(l)return this.openMentions.length>2&&(this.openMentions[0].close(),this.openMentions.shift()),void this.openMentions.push(c);this.openNotifications.length>2&&(this.openNotifications[0].close(),this.openNotifications.shift()),this.openNotifications.push(c),setTimeout(function(){c.close&&c.close()},3e3)}}})}(window,$,_,notify),+function(e,t,i){e.LCB=e.LCB||{},e.LCB.TabsView=Backbone.View.extend({events:{"click .lcb-tab-close":"leave"},focus:!0,initialize:function(o){this.client=o.client,this.template=Handlebars.compile(t("#template-room-tab").html()),this.rooms=o.rooms,this.rooms.on("change:joined",function(e,t){return t?void this.add(e.toJSON()):void this.remove(e.id)},this),this.rooms.on("change:name change:description",this.update,this),this.rooms.current.on("change:id",function(e,t){this["switch"](t),this.clearAlerts(t)},this),this.rooms.on("messages:new",this.alert,this),this["switch"](this.rooms.current.get("id")),t(e).on("focus blur",i.bind(this.onFocusBlur,this)),this.render()},add:function(e){this.$el.append(this.template(e))},remove:function(e){this.$el.find(".lcb-tab[data-id="+e+"]").remove()},update:function(e){this.$el.find(".lcb-tab[data-id="+e.id+"] .lcb-tab-title").text(e.get("name"))},"switch":function(e){e||(e="list"),this.$el.find(".lcb-tab").removeClass("selected").filter("[data-id="+e+"]").addClass("selected")},leave:function(e){e.preventDefault();var i=t(e.currentTarget).closest("[data-id]").data("id");this.client.events.trigger("rooms:leave",i)},alert:function(e){var t=this.$(".lcb-tab[data-id="+e.room.id+"]"),i=t.find(".lcb-tab-alerts-total"),o=t.find(".lcb-tab-alerts-mentions");if(!(e.historical||0===t.length||this.rooms.current.get("id")===e.room.id&&this.focus)){var s=parseInt(t.data("count-total"))||0,n=parseInt(t.data("count-mentions"))||0;t.data("count-total",++s),i.text(s),new RegExp("\\B@("+this.client.user.get("username")+")(?!@)\\b","i").test(e.text)&&(t.data("count-mentions",++n),o.text(n))}},clearAlerts:function(e){var t=this.$(".lcb-tab[data-id="+e+"]"),i=t.find(".lcb-tab-alerts-total"),o=t.find(".lcb-tab-alerts-mentions");t.data("count-total",0).data("count-mentions",0),i.text(""),o.text("")},onFocusBlur:function(e){var t=this;return this.focus="focus"===e.type,clearTimeout(this.clearTimer),this.focus?void(this.clearTimer=setTimeout(function(){t.clearAlerts(t.rooms.current.get("id"))},1e3)):void t.clearAlerts(t.rooms.current.get("id"))}}),e.LCB.PanesView=Backbone.View.extend({initialize:function(e){this.client=e.client,this.template=Handlebars.compile(t("#template-room").html()),this.rooms=e.rooms,this.views={},this.rooms.on("change:joined",function(e,t){return t?void this.add(e):void this.remove(e.id)},this),this.rooms.current.on("change:id",function(e,t){this["switch"](t)},this),this["switch"](this.rooms.current.get("id"))},"switch":function(i){i||(i="list");var o=this.$el.find(".lcb-pane[data-id="+i+"]");o.removeClass("hide").siblings().addClass("hide"),t(e).width()>767&&o.find("[autofocus]").focus(),this.views[i]&&this.views[i].scrollMessages(!0)},add:function(t){this.views[t.id]||(this.views[t.id]=new e.LCB.RoomView({client:this.client,template:this.template,model:t}),this.$el.append(this.views[t.id].$el))},remove:function(e){this.views[e]&&(this.views[e].destroy(),delete this.views[e])}})}(window,$,_),+function(e,t,i){e.LCB=e.LCB||{},e.LCB.ModalView=Backbone.View.extend({events:{"submit form":"submit"},initialize:function(e){this.render()},render:function(){this.$("form.validate").validate(),this.$el.on("shown.bs.modal hidden.bs.modal",i.bind(this.refresh,this))},refresh:function(){var e=this;this.$("[data-model]").each(function(){t(this).val&&t(this).val(e.model.get(t(this).data("model")))})},success:function(){swal("Updated!","","success"),this.$el.modal("hide")},error:function(){swal("Woops!","","error")},submit:function(e){e&&e.preventDefault();var o=this.$("form[action]"),s={type:o.attr("method")||"POST",url:o.attr("action"),data:o.serialize(),dataType:"json"};this.success&&(s.success=i.bind(this.success,this)),this.error&&(s.error=i.bind(this.error,this)),this.complete&&(s.complete=i.bind(this.complete,this)),t.ajax(s)}}),e.LCB.ProfileModalView=e.LCB.ModalView.extend({success:function(){swal("Profile Updated!","Your profile has been updated.","success"),this.$el.modal("hide")},error:function(){swal("Woops!","Your profile was not updated.","error")}}),e.LCB.AccountModalView=e.LCB.ModalView.extend({success:function(){swal("Account Updated!","Your account has been updated.","success"),this.$el.modal("hide"),this.$('[type="password"]').val("")},error:function(e){var t=e.responseJSON&&e.responseJSON.reason||"Your account was not updated.";swal("Woops!",t,"error")},complete:function(){this.$('[name="current-password"]').val("")}}),e.LCB.RoomPasswordModalView=Backbone.View.extend({events:{"click .btn-primary":"enterRoom"},initialize:function(e){this.render(),this.$name=this.$(".lcb-room-password-name"),this.$password=this.$("input.lcb-room-password-required")},render:function(){},show:function(e){this.callback=e.callback,this.$password.val(""),this.$name.text(e.roomName||""),this.$el.modal("show")},enterRoom:function(){this.$el.modal("hide"),this.callback(this.$password.val())}}),e.LCB.AuthTokensModalView=Backbone.View.extend({events:{"click .generate-token":"generateToken","click .revoke-token":"revokeToken"},initialize:function(e){this.render()},render:function(){this.$el.on("shown.bs.modal hidden.bs.modal",i.bind(this.refresh,this))},refresh:function(){this.$(".token").val(""),this.$(".generated-token").hide()},getToken:function(){var e=this;t.post("./account/token/generate",function(t){t.token&&(e.$(".token").val(t.token),e.$(".generated-token").show())})},removeToken:function(){var e=this;t.post("./account/token/revoke",function(t){e.refresh(),swal("Success","Authentication token revoked!","success")})},generateToken:function(){swal({title:"Are you sure?",text:"This will overwrite any existing authentication token you may have.",type:"warning",showCancelButton:!0,confirmButtonText:"Yes",closeOnConfirm:!0},i.bind(this.getToken,this))},revokeToken:function(){swal({title:"Are you sure?",text:"This will revoke access from any process using your current authentication token.",type:"warning",showCancelButton:!0,confirmButtonText:"Yes",closeOnConfirm:!1},i.bind(this.removeToken,this))}}),e.LCB.NotificationsModalView=Backbone.View.extend({events:{"click [name=desktop-notifications]":"toggleDesktopNotifications"},initialize:function(){this.render()},render:function(){var e=this.$("[name=desktop-notifications]");return e.find(".disabled").show().siblings().hide(),notify.isSupported?(notify.permissionLevel()===notify.PERMISSION_GRANTED&&e.find(".enabled").show().siblings().hide(),void(notify.permissionLevel()===notify.PERMISSION_DENIED&&e.find(".blocked").show().siblings().hide())):void e.attr("disabled",!0)},toggleDesktopNotifications:function(){var e=this;notify.isSupported&&notify.requestPermission(function(){e.render()})}}),e.LCB.GiphyModalView=Backbone.View.extend({events:{"keypress .search-giphy":"stopReturn","keyup .search-giphy":"loadGifs"},initialize:function(e){this.render()},render:function(){this.$el.on("shown.bs.modal hidden.bs.modal",i.bind(this.refresh,this))},refresh:function(){this.$el.find(".giphy-results ul").empty(),this.$(".search-giphy").val("").focus()},stopReturn:function(e){return 13===e.keyCode?!1:void 0},loadGifs:i.debounce(function(){var e=this,i=this.$el.find(".search-giphy").val();t.get("https://api.giphy.com/v1/gifs/search",{q:i,rating:this.$el.data("rating"),limit:this.$el.data("limit"),api_key:this.$el.data("apikey")}).done(function(t){var i=t.data.filter(function(e){return e.images.fixed_width.url}).map(function(e){return e.images.fixed_width.url});e.appendGifs(i)})},400),appendGifs:function(e){var i=e.map(function(e){var i=this,o=t('<img src="'+e+'" alt="gif" data-dismiss="modal"/></li>');return o.click(function(){var e=t(this).attr("src");t(".lcb-entry-input:visible").val(e),t(".lcb-entry-button:visible").click(),i.$el.modal("hide")}),t("<li>").append(o)},this),o=this.$el.find(".giphy-results ul");o.empty(),i.forEach(function(e){o.append(e)})}})}(window,$,_),Dropzone&&(Dropzone.autoDiscover=!1),+function(e,t,i){e.LCB=e.LCB||{},e.LCB.UploadView=Backbone.View.extend({events:{"submit form":"submit"},initialize:function(e){this.template=t("#template-upload").html(),this.rooms=e.rooms,this.rooms.current.on("change:id",this.setRoom,this),this.rooms.on("add remove",this.populateRooms,this),this.rooms.on("change:joined",this.populateRooms,this),this.rooms.on("upload:show",this.show,this),this.render()},render:function(){var e=this.$el.closest(".lcb-client").get(0);this.dropzone=new Dropzone(e,{url:"./files",autoProcessQueue:!1,clickable:[this.$(".lcb-upload-target").get(0)],previewsContainer:this.$(".lcb-upload-preview-files").get(0),addRemoveLinks:!0,dictRemoveFile:"Remove",parallelUploads:8,maxFiles:8,previewTemplate:this.template}),this.dropzone.on("sending",i.bind(this.sending,this)).on("sendingmultiple",i.bind(this.sending,this)).on("addedfile",i.bind(this.show,this)).on("queuecomplete",i.bind(this.complete,this)),this.selectize=this.$('select[name="room"]').selectize({valueField:"id",labelField:"name",searchField:"name"}).get(0).selectize,this.$el.on("hidden.bs.modal",i.bind(this.clear,this)),this.$el.on("shown.bs.modal",i.bind(this.setRoom,this))},show:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")},clear:function(){this.dropzone.removeAllFiles()},complete:function(e){var t=i.some(this.dropzone.files,function(e){return"success"!==e.status});return t?void swal("Woops!","There were some issues uploading your files.","warning"):(this.hide(),void swal("Success","Files uploaded!","success"))},sending:function(e,t,i){i.append("room",this.$('select[name="room"]').val()),i.append("post",this.$('input[name="post"]').is(":checked"))},submit:function(e){return e.preventDefault(),this.$('select[name="room"]').val()?void this.dropzone.processQueue():void swal("Woops!","Please specify a room.","warning")},setRoom:function(){this.selectize.setValue(this.rooms.current.id)},populateRooms:function(){this.selectize.clearOptions(),this.rooms.each(function(e){e.get("joined")&&this.selectize.addOption({id:e.id,name:e.get("name")})},this)}})}(window,$,_),+function(e,t,i){e.LCB=e.LCB||{},e.LCB.ClientView=Backbone.View.extend({el:"#lcb-client",events:{"click .lcb-tab":"toggleSideBar","click .lcb-header-toggle":"toggleSideBar"},initialize:function(t){return this.client=t.client,this.browser=new e.LCB.BrowserView({el:this.$el.find(".lcb-rooms-browser"),rooms:this.client.rooms,client:this.client}),this.tabs=new e.LCB.TabsView({el:this.$el.find(".lcb-tabs"),rooms:this.client.rooms,client:this.client}),this.panes=new e.LCB.PanesView({el:this.$el.find(".lcb-panes"),rooms:this.client.rooms,client:this.client}),this.window=new e.LCB.WindowView({rooms:this.client.rooms,client:this.client}),this.hotKeys=new e.LCB.HotKeysView({rooms:this.client.rooms,client:this.client}),this.status=new e.LCB.StatusView({el:this.$el.find(".lcb-status-indicators"),
client:this.client}),this.accountButton=new e.LCB.AccountButtonView({el:this.$el.find(".lcb-account-button"),model:this.client.user}),this.desktopNotifications=new e.LCB.DesktopNotificationsView({rooms:this.client.rooms,client:this.client}),this.client.options.filesEnabled&&(this.upload=new e.LCB.UploadView({el:this.$el.find("#lcb-upload"),rooms:this.client.rooms})),this.profileModal=new e.LCB.ProfileModalView({el:this.$el.find("#lcb-profile"),model:this.client.user}),this.accountModal=new e.LCB.AccountModalView({el:this.$el.find("#lcb-account"),model:this.client.user}),this.tokenModal=new e.LCB.AuthTokensModalView({el:this.$el.find("#lcb-tokens")}),this.notificationsModal=new e.LCB.NotificationsModalView({el:this.$el.find("#lcb-notifications")}),this.giphyModal=new e.LCB.GiphyModalView({el:this.$el.find("#lcb-giphy")}),this.client.status.once("change:connected",i.bind(function(e,t){this.$el.find(".lcb-client-loading").hide(t)},this)),this},toggleSideBar:function(e){this.$el.toggleClass("lcb-sidebar-opened")}}),e.LCB.AccountButtonView=Backbone.View.extend({initialize:function(){this.model.on("change",this.update,this)},update:function(e){this.$(".lcb-account-button-username").text("@"+e.get("username")),this.$(".lcb-account-button-name").text(e.get("displayName"))}})}(window,$,_),function(e,t,i){var o=function(e){return this.options=e,this.status=new Backbone.Model,this.user=new UserModel,this.users=new UsersCollection,this.rooms=new RoomsCollection,this.events=i.extend({},Backbone.Events),this};o.prototype.getUser=function(){var e=this;this.socket.emit("account:whoami",function(t){e.user.set(t)})},o.prototype.updateProfile=function(e){var t=this;this.socket.emit("account:profile",e,function(e){t.user.set(e)})},o.prototype.createRoom=function(e){var t=this,i={name:e.name,slug:e.slug,description:e.description,password:e.password,participants:e.participants,"private":e["private"]},o=e.callback;this.socket.emit("rooms:create",i,function(e){e&&e.errors?swal("Unable to create room","Room slugs can only contain lower case letters, numbers or underscores!","error"):e&&e.id&&(t.addRoom(e),t.switchRoom(e.id)),o&&o(e)})},o.prototype.getRooms=function(e){var t=this;this.socket.emit("rooms:list",{users:!0},function(o){t.rooms.set(o),i.each(o,function(e){e.users&&t.setUsers(e.id,e.users)}),e&&e(o)})},o.prototype.switchRoom=function(e){if(this.rooms.last.set("id",this.rooms.current.get("id")),!e||"list"===e)return this.rooms.current.set("id","list"),void this.router.navigate("!/",{replace:!0});var t=this.rooms.get(e);return t&&t.get("joined")?(this.rooms.current.set("id",e),void this.router.navigate("!/room/"+t.id,{replace:!0})):void(t?this.joinRoom(t,!0):this.joinRoom({id:e},!0))},o.prototype.updateRoom=function(e){this.socket.emit("rooms:update",e)},o.prototype.roomUpdate=function(e){var t=this.rooms.get(e.id);return t?void t.set(e):void this.addRoom(e)},o.prototype.addRoom=function(e){var t=this.rooms.get(e.id);return t?t:this.rooms.add(e)},o.prototype.archiveRoom=function(e){this.socket.emit("rooms:archive",e,function(e){"No Content"!==e&&swal("Unable to Archive!","Unable to archive this room!","error")})},o.prototype.roomArchive=function(e){this.leaveRoom(e.id),this.rooms.remove(e.id)},o.prototype.rejoinRoom=function(e){this.joinRoom(e,void 0,!0)},o.prototype.lockJoin=function(e){return i.contains(this.joining,e)?!1:(this.joining=this.joining||[],this.joining.push(e),!0)},o.prototype.unlockJoin=function(e){var t=this;i.defer(function(){t.joining=i.without(t.joining,e)})},o.prototype.joinRoom=function(e,t,o){if(e&&e.id){var s=this,n=e.id,r=e.password;if(!o){var a=s.rooms.get(n);if(a&&a.get("joined"))return}if(this.lockJoin(n)){var l=function(i){e.password=i,s.joinRoom(e,t,o)};this.socket.emit("rooms:join",{roomId:n,password:r},function(e){if(e){if(e&&e.errors&&"password required"===e.errors)return s.passwordModal.show({roomName:e.roomName,callback:l}),void s.unlockJoin(n);if(e&&e.errors)return void s.unlockJoin(n);var r=s.addRoom(e);r.set("joined",!0),r.get("hasPassword")&&s.getRoomUsers(r.id,i.bind(function(e){this.setUsers(r.id,e)},s)),s.getMessages({room:r.id,since_id:r.lastMessage.get("id"),take:200,expand:"owner, room",reverse:!0},function(e){e.reverse(),s.addMessages(e,!o&&!r.lastMessage.get("id")),!o&&r.lastMessage.set(e[e.length-1])}),s.options.filesEnabled&&s.getFiles({room:r.id,take:15},function(e){e.reverse(),s.setFiles(r.id,e)}),t&&s.switchRoom(n);var a=s.user.get("openRooms");i.contains(a,n)||a.push(n),s.socket.emit("account:profile",{openRooms:a}),s.unlockJoin(n)}})}}},o.prototype.leaveRoom=function(e){var t=this.rooms.get(e);if(t&&(t.set("joined",!1),t.lastMessage.clear(),t.get("hasPassword")&&t.users.set([])),this.socket.emit("rooms:leave",e),e===this.rooms.current.get("id")){var t=this.rooms.get(this.rooms.last.get("id"));this.switchRoom(t&&t.get("joined")?t.id:"")}var o=this.user.get("openRooms");o=i.without(o,e),this.socket.emit("account:profile",{openRooms:o})},o.prototype.getRoomUsers=function(e,t){this.socket.emit("rooms:users",{room:e},t)},o.prototype.addMessage=function(e){var t=this.rooms.get(e.room);t&&e&&(t.set("lastActive",e.posted),e.historical||t.lastMessage.set(e),t.trigger("messages:new",e))},o.prototype.addMessages=function(e,t){i.each(e,function(e){t&&(e.historical=!0),this.addMessage(e)},this)},o.prototype.sendMessage=function(e){this.socket.emit("messages:create",e)},o.prototype.getMessages=function(e,t){this.socket.emit("messages:list",e,t)},o.prototype.getFiles=function(e,t){this.socket.emit("files:list",{room:e.room||"",take:e.take||40,expand:e.expand||"owner"},t)},o.prototype.setFiles=function(e,t){if(e&&t&&t.length){var i=this.rooms.get(e);i&&i.files.set(t)}},o.prototype.addFile=function(e){var t=this.rooms.get(e.room);t&&t.files.add(e)},o.prototype.setUsers=function(e,t){if(e&&t&&t.length){var i=this.rooms.get(e);i&&i.users.set(t)}},o.prototype.addUser=function(e){var t=this.rooms.get(e.room);t&&t.users.add(e)},o.prototype.removeUser=function(e){var t=this.rooms.get(e.room);t&&t.users.remove(e.id)},o.prototype.updateUser=function(e){e.id==this.user.id&&this.user.set(e),this.rooms.each(function(t){var i=t.users.findWhere({id:e.id});i&&i.set(e)},this)},o.prototype.getUsersSync=function(){function e(e){i.users.set(e)}if(this.users.length)return this.users;var i=this;return t.ajax({url:"./users",async:!1,success:e}),this.users},o.prototype.getEmotes=function(e){this.extras=this.extras||{},this.extras.emotes||(this.extras.emotes=t.get("./extras/emotes")),e&&this.extras.emotes.done(e)},o.prototype.getReplacements=function(e){this.extras=this.extras||{},this.extras.replacements||(this.extras.replacements=t.get("./extras/replacements")),e&&this.extras.replacements.done(e)},o.prototype.route=function(){var e=this,t=Backbone.Router.extend({routes:{"!/room/":"list","!/room/:id":"join","*path":"list"},join:function(t){e.switchRoom(t)},list:function(){e.switchRoom("list")}});this.router=new t,Backbone.history.start()},o.prototype.listen=function(){function t(e){var t=i.map(e,function(e){return e.id}),s=o.user.get("openRooms")||[];i.defer(function(){i.each(s,function(e){i.contains(t,e)&&o.joinRoom({id:e})})}.bind(this))}var o=this,s="/"+i.compact(e.location.pathname.split("/").concat(["socket.io"])).join("/");this.socket=io.connect({path:s,reconnection:!0,reconnectionDelay:500,reconnectionDelayMax:1e3,timeout:3e3}),this.socket.on("connect",function(){o.getUser(),o.getRooms(t),o.status.set("connected",!0)}),this.socket.on("reconnect",function(){i.each(o.rooms.where({joined:!0}),function(e){o.rejoinRoom(e)})}),this.socket.on("messages:new",function(e){o.addMessage(e)}),this.socket.on("rooms:new",function(e){o.addRoom(e)}),this.socket.on("rooms:update",function(e){o.roomUpdate(e)}),this.socket.on("rooms:archive",function(e){o.roomArchive(e)}),this.socket.on("users:join",function(e){o.addUser(e)}),this.socket.on("users:leave",function(e){o.removeUser(e)}),this.socket.on("users:update",function(e){o.updateUser(e)}),this.socket.on("files:new",function(e){o.addFile(e)}),this.socket.on("disconnect",function(){o.status.set("connected",!1)}),this.events.on("messages:send",this.sendMessage,this),this.events.on("rooms:update",this.updateRoom,this),this.events.on("rooms:leave",this.leaveRoom,this),this.events.on("rooms:create",this.createRoom,this),this.events.on("rooms:switch",this.switchRoom,this),this.events.on("rooms:archive",this.archiveRoom,this),this.events.on("profile:update",this.updateProfile,this),this.events.on("rooms:join",this.joinRoom,this)},o.prototype.start=function(){return this.getEmotes(),this.getReplacements(),this.listen(),this.route(),this.view=new e.LCB.ClientView({client:this}),this.passwordModal=new e.LCB.RoomPasswordModalView({el:t("#lcb-password")}),this},e.LCB=e.LCB||{},e.LCB.Client=o}(window,$,_),$(function(){window.client=new window.LCB.Client({filesEnabled:$("#lcb-upload").length>0,giphyEnabled:$("#lcb-giphy").length>0}),window.client.start()});